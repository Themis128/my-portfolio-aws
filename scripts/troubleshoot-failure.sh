#!/bin/bash

# Failed Deployment Troubleshooter
# Helps diagnose and fix deployment failures

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘         Deployment Failure Troubleshooter             â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${RED}ğŸš¨ DEPLOYMENT FAILED${NC}"
echo ""
echo "Deployment #44 failed at 9:40 AM (2 min 57 sec)"
echo "Commit: f0725bb - Fix: Frontend/backend sync..."
echo ""

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${YELLOW}ğŸ“Š Common Deployment Failures & Solutions${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

echo -e "${RED}Common Issue 1: Build Errors${NC}"
echo ""
echo "Symptoms:"
echo "  â€¢ 'npm ERR!' in logs"
echo "  â€¢ 'Failed to compile'"
echo "  â€¢ TypeScript errors"
echo ""
echo "Likely causes:"
echo "  â€¢ Missing dependencies"
echo "  â€¢ TypeScript compilation errors"
echo "  â€¢ Import path issues"
echo ""
echo "How to check:"
echo "  1. Open Amplify Console build logs"
echo "  2. Look for 'BUILD' phase"
echo "  3. Find red error messages"
echo ""
echo "Quick fixes:"
echo "  â€¢ Check package.json dependencies"
echo "  â€¢ Run 'npm install' locally"
echo "  â€¢ Fix TypeScript errors"
echo ""

echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

echo -e "${RED}Common Issue 2: Backend Deployment Errors${NC}"
echo ""
echo "Symptoms:"
echo "  â€¢ 'Amplify push failed'"
echo "  â€¢ Backend build errors"
echo "  â€¢ Lambda deployment failed"
echo ""
echo "Likely causes:"
echo "  â€¢ amplify_outputs.json issues"
echo "  â€¢ Backend schema changes"
echo "  â€¢ IAM permission issues"
echo ""
echo "Quick fixes:"
echo "  â€¢ Check amplify/backend files"
echo "  â€¢ Verify Lambda handler code"
echo "  â€¢ Check IAM roles"
echo ""

echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

echo -e "${RED}Common Issue 3: Environment Issues${NC}"
echo ""
echo "Symptoms:"
echo "  â€¢ 'Node not found'"
echo "  â€¢ Version mismatch"
echo "  â€¢ Package manager errors"
echo ""
echo "Likely causes:"
echo "  â€¢ Node.js version incompatibility"
echo "  â€¢ npm/pnpm configuration"
echo "  â€¢ Missing build commands"
echo ""
echo "Quick fixes:"
echo "  â€¢ Check amplify.yml node version"
echo "  â€¢ Verify build commands"
echo "  â€¢ Update package.json"
echo ""

echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${CYAN}ğŸ” IMMEDIATE ACTIONS${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

echo "1. Check Build Logs in Amplify Console:"
echo "   https://eu-central-1.console.aws.amazon.com/amplify"
echo ""
echo "   Look for:"
echo "   â€¢ Red error messages"
echo "   â€¢ Failed phase (Provision/Build/Deploy)"
echo "   â€¢ Specific error codes"
echo ""

echo "2. Check CloudWatch Logs:"
echo "   https://eu-central-1.console.aws.amazon.com/cloudwatch"
echo ""

echo "3. Review Recent Changes:"
echo "   â€¢ What files changed in commit f0725bb?"
echo "   â€¢ Any new dependencies?"
echo "   â€¢ Configuration changes?"
echo ""

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}ğŸ› ï¸  TROUBLESHOOTING STEPS${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

echo "Step 1: Get Error Details"
echo ""
echo "a) In Amplify Console:"
echo "   â€¢ Click on failed deployment #44"
echo "   â€¢ Expand each phase"
echo "   â€¢ Copy error messages"
echo ""
echo "b) Look for these patterns:"
echo "   â€¢ 'Error:' lines"
echo "   â€¢ 'FAILED' status"
echo "   â€¢ Stack traces"
echo ""

echo "Step 2: Test Locally"
echo ""
echo "Try building locally to reproduce:"
echo "  cd /home/tbaltzakis/my-portfolio-aws"
echo "  npm install"
echo "  npm run build"
echo ""
echo "If local build fails, fix errors before redeploying"
echo ""

echo "Step 3: Check Key Files"
echo ""
echo "Verify these files are correct:"
echo "  â€¢ package.json - all dependencies listed"
echo "  â€¢ next.config.ts - valid configuration"
echo "  â€¢ amplify.yml - correct build commands"
echo "  â€¢ tsconfig.json - valid TypeScript config"
echo ""

echo "Step 4: Review Recent Changes"
echo ""
echo "What changed in this commit?"
echo "  git diff HEAD~1 HEAD"
echo ""
echo "Focus on:"
echo "  â€¢ New imports"
echo "  â€¢ Configuration changes"
echo "  â€¢ New dependencies"
echo ""

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${YELLOW}ğŸ”§ LIKELY FIXES${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

echo "Based on your recent changes, check:"
echo ""

echo "1. lib/amplify-client-config.ts"
echo "   â€¢ Verify import paths are correct"
echo "   â€¢ Check amplify_outputs.json exists"
echo "   â€¢ Ensure proper 'use client' directive"
echo ""

echo "2. components/Contact.tsx"
echo "   â€¢ Check import of amplify-client-config"
echo "   â€¢ Verify relative path: '../lib/amplify-client-config'"
echo "   â€¢ Ensure GraphQL mutation is correct"
echo ""

echo "3. Build Configuration"
echo "   â€¢ Check amplify.yml has correct commands"
echo "   â€¢ Verify Node.js version specified"
echo "   â€¢ Check if all scripts exist in package.json"
echo ""

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${CYAN}ğŸ“‹ CHECKLIST${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

echo "Before redeploying, verify:"
echo ""
echo "  [ ] Reviewed Amplify Console error logs"
echo "  [ ] Identified specific error message"
echo "  [ ] Tested build locally (if possible)"
echo "  [ ] Fixed any TypeScript errors"
echo "  [ ] Verified all import paths"
echo "  [ ] Checked amplify.yml configuration"
echo "  [ ] Committed fix to git"
echo ""

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}ğŸš€ REDEPLOY PROCESS${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

echo "After fixing the issue:"
echo ""
echo "1. Stage your fixes:"
echo "   git add ."
echo ""
echo "2. Commit with descriptive message:"
echo "   git commit -m 'Fix: [describe the fix]'"
echo ""
echo "3. Push to trigger new deployment:"
echo "   git push"
echo ""
echo "4. Monitor in Amplify Console"
echo ""

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${RED}âš ï¸  IMPORTANT${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

echo "To properly diagnose this, we need:"
echo ""
echo "1. FULL BUILD LOGS from Amplify Console"
echo "   â€¢ Go to: https://eu-central-1.console.aws.amazon.com/amplify"
echo "   â€¢ Click deployment #44"
echo "   â€¢ Copy the complete error message"
echo ""
echo "2. Specific phase that failed:"
echo "   â€¢ Provision?"
echo "   â€¢ Build?"
echo "   â€¢ Deploy?"
echo ""
echo "3. Error message text"
echo ""

echo -e "${YELLOW}Please share the error logs so I can provide specific fixes!${NC}"
echo ""

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${CYAN}ğŸ“ Next Steps${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

echo "Get the error details by:"
echo ""
echo "1. Opening Amplify Console"
echo "   https://eu-central-1.console.aws.amazon.com/amplify"
echo ""
echo "2. Click on deployment #44 (Failed)"
echo ""
echo "3. Look at each phase and find the red error"
echo ""
echo "4. Share the error message"
echo ""
echo "Then I can provide an exact fix! ğŸ”§"
echo ""
