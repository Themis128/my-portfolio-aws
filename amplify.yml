version: 1
backend:
  phases:
    preBuild:
      commands:
        - echo "=== Starting Backend preBuild phase ==="
        - echo "=== Checking pnpm availability ==="
        - which pnpm || npm install -g pnpm
        - echo "=== Installing backend dependencies ==="
        - pnpm install --frozen-lockfile
        - echo "=== Backend preBuild completed successfully ==="
    build:
      commands:
        - echo "=== Starting Backend build ==="
        - npx ampx pipeline-deploy --outputs-format json --outputs-path amplify_outputs.json
        - echo "=== Backend build completed successfully ==="
  cache:
    paths:
      - node_modules/**/*
      - ~/.pnpm-store/**/*
      - amplify_outputs.json
frontend:
  phases:
    preBuild:
      commands:
        - echo "=== Starting Frontend preBuild phase ==="
        - echo "=== Checking pnpm availability ==="
        - which pnpm || npm install -g pnpm
        - echo "=== Installing frontend dependencies ==="
        - pnpm install --frozen-lockfile
        - echo "=== Frontend preBuild completed successfully ==="
    build:
      commands:
        - echo "=== Starting Next.js build ==="
        - pnpm run build
        - echo "=== Build completed successfully ==="
  artifacts:
    baseDirectory: out
    files:
      - '**/*'
    exclude:
      - '*.map'
      - '*.tsbuildinfo'  # Exclude TypeScript build info files
  cache:
    # Optimized caching strategy for Amplify builds
    paths:
      - node_modules/**/*
      - ~/.pnpm-store/**/*
      - .next/cache/**/*
      - amplify_outputs.json  # Cache the backend configuration
      # Cache Next.js build cache for faster subsequent builds
      - .next/**/*
      # Exclude large or unnecessary cache files
      - '!node_modules/.cache/**'
      - '!node_modules/.pnpm-debug.log*'
