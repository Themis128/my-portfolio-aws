name: üöÄ Production Deployment Pipeline

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment without waiting for tests'
        required: false
        default: false
        type: boolean
      rollback_version:
        description: 'Rollback to specific commit (leave empty for latest)'
        required: false
        type: string

env:
  NODE_VERSION: '20'
  PRODUCTION_APP_ID: dfltlhnwu9p09
  PRODUCTION_BRANCH: master

jobs:
  # Quality Assurance Phase
  quality-gate:
    name: üîç Quality Assurance
    runs-on: ubuntu-latest
    outputs:
      test-results: ${{ steps.test-results.outputs.results }}
      security-scan: ${{ steps.security.outputs.status }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.14.4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run comprehensive tests
        id: test-results
        run: |
          echo "üß™ Running comprehensive test suite..."

          # Unit tests
          pnpm run test -- --coverage --watchAll=false
          TEST_EXIT_CODE=$?

          # E2E tests (if configured)
          if [ -f "playwright.config.ts" ]; then
            npx playwright install-deps
            npx playwright test --headed=false
            E2E_EXIT_CODE=$?
          else
            E2E_EXIT_CODE=0
          fi

          # Calculate overall result
          if [ $TEST_EXIT_CODE -eq 0 ] && [ $E2E_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ All tests passed"
            echo "results=passed" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Tests failed"
            echo "results=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run linting and type checking
        run: |
          echo "üîç Running code quality checks..."
          pnpm lint
          npx tsc --noEmit

      - name: Security audit
        id: security
        run: |
          echo "üîí Running security audit..."
          pnpm audit --audit-level moderate
          if [ $? -eq 0 ]; then
            echo "‚úÖ Security audit passed"
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Security vulnerabilities found"
            echo "status=failed" >> $GITHUB_OUTPUT
            # Don't fail the job, just report
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            coverage/
            test-results/
            playwright-report/

  # Staging Deployment (for validation)
  staging-validation:
    name: üß™ Staging Validation
    needs: quality-gate
    if: needs.quality-gate.outputs.test-results == 'passed'
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.14.4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build for staging
        run: pnpm run build
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          NEXT_PUBLIC_ENVIRONMENT: staging

      - name: Deploy to Staging
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - name: Deploy Frontend to Staging
        run: |
          aws amplify start-deployment \
            --app-id ${{ env.PRODUCTION_APP_ID }} \
            --branch-name staging \
            --source-dir .

      - name: Deploy Backend to Staging
        run: |
          npx ampx pipeline-deploy \
            --app-id ${{ env.PRODUCTION_APP_ID }} \
            --branch-name staging \
            --outputs-format json \
            --outputs-out-dir ./staging_outputs

      - name: Staging Health Check
        run: |
          echo "üè• Running staging health checks..."
          sleep 60  # Wait for deployment

          # Check if staging site is accessible
          curl -f -s https://staging.dfltlhnwu9p09.amplifyapp.com > /dev/null
          if [ $? -eq 0 ]; then
            echo "‚úÖ Staging site is accessible"
          else
            echo "‚ùå Staging site is not accessible"
            exit 1
          fi

  # Production Deployment (with approval)
  production-deploy:
    name: üöÄ Production Deployment
    needs: [quality-gate, staging-validation]
    if: |
      (needs.quality-gate.outputs.test-results == 'passed' &&
       needs.staging-validation.result == 'success') ||
      github.event.inputs.force_deploy == 'true'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.rollback_version || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.14.4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build for production
        run: pnpm run build
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          NEXT_PUBLIC_ENVIRONMENT: production
          NEXT_TELEMETRY_DISABLED: "1"

      - name: Performance baseline check
        run: |
          echo "üìä Running performance baseline check..."
          npx lighthouse https://baltzakisthemis.com \
            --output=json \
            --output-path=./baseline-results.json \
            --quiet || echo "Baseline check completed"

      - name: Deploy to Production
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - name: Deploy Frontend to Production
        run: |
          echo "üöÄ Deploying frontend to production..."
          aws amplify start-deployment \
            --app-id ${{ env.PRODUCTION_APP_ID }} \
            --branch-name ${{ env.PRODUCTION_BRANCH }} \
            --source-dir .

      - name: Deploy Backend to Production
        run: |
          echo "üöÄ Deploying backend to production..."
          npx ampx pipeline-deploy \
            --app-id ${{ env.PRODUCTION_APP_ID }} \
            --branch-name ${{ env.PRODUCTION_BRANCH }} \
            --outputs-format json \
            --outputs-out-dir ./production_outputs

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-deployment
          path: |
            production_outputs/
            baseline-results.json

  # Post-Deployment Monitoring
  production-monitoring:
    name: üìä Production Monitoring
    needs: production-deploy
    runs-on: ubuntu-latest
    if: needs.production-deploy.result == 'success'

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 120

      - name: Production Health Check
        run: |
          echo "üè• Running production health checks..."

          # Check site accessibility
          curl -f -s https://baltzakisthemis.com > /dev/null
          if [ $? -eq 0 ]; then
            echo "‚úÖ Production site is accessible"
          else
            echo "‚ùå Production site is not accessible"
            exit 1
          fi

          # Check API endpoints
          curl -f -s https://baltzakisthemis.com/api/health > /dev/null
          if [ $? -eq 0 ]; then
            echo "‚úÖ API endpoints are responding"
          else
            echo "‚ö†Ô∏è API endpoints not accessible (may be expected)"
          fi

      - name: Performance validation
        run: |
          echo "‚ö° Running post-deployment performance check..."
          npx lighthouse https://baltzakisthemis.com \
            --output=json \
            --output-path=./post-deploy-results.json \
            --quiet || echo "Performance check completed"

      - name: Deployment notification
        run: |
          echo "üéâ Production deployment completed successfully!"
          echo "üìä Deployment Summary:"
          echo "   - Environment: Production"
          echo "   - Branch: ${{ env.PRODUCTION_BRANCH }}"
          echo "   - Commit: ${{ github.sha }}"
          echo "   - Deployed by: ${{ github.actor }}"
          echo "   - Timestamp: $(date)"

      - name: Upload monitoring results
        uses: actions/upload-artifact@v4
        with:
          name: production-monitoring
          path: ./post-deploy-results.json

  # Rollback job (manual trigger)
  rollback:
    name: üîÑ Rollback Production
    if: failure() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Rollback notification
        run: |
          echo "‚ö†Ô∏è Deployment failed or health checks failed"
          echo "üîÑ Consider manual rollback if needed"
          echo "   Previous deployment can be restored via Amplify console"
