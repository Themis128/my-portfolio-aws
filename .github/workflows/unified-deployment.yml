name: üöÄ Unified Production Deployment

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment without waiting for tests'
        required: false
        default: false
        type: boolean
      rollback_version:
        description: 'Rollback to specific commit (leave empty for latest)'
        required: false
        type: string
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  PRODUCTION_APP_ID: dcwmv1pw85f0j
  PRODUCTION_BRANCH: master

jobs:
  # Comprehensive Quality Assurance Phase
  quality-assurance:
    name: üîç Quality Assurance & Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      test-results: ${{ steps.test-results.outputs.results }}
      security-scan: ${{ steps.security.outputs.status }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run comprehensive test suite
        id: test-results
        run: |
          echo "üß™ Running comprehensive test suite..."

          # Unit tests
          pnpm run test -- --coverage --watchAll=false
          TEST_EXIT_CODE=$?

          # E2E tests (if Playwright is configured)
          if [ -f "playwright.config.ts" ]; then
            echo "üé≠ Installing Playwright browsers..."
            npx playwright install --with-deps

            echo "üîç Checking API connectivity before tests..."
            # Check if AppSync endpoint is accessible
            API_AVAILABLE=false
            if grep -q "appsync-api" playwright.config.ts 2>/dev/null; then
              echo "‚ö†Ô∏è AppSync endpoint detected in Playwright config"

              # Extract AppSync endpoint from config (basic grep)
              APPSYNC_URL=$(grep -o "https://[a-zA-Z0-9.-]*\.appsync-api\.[a-z0-9-]*\.amazonaws\.com" playwright.config.ts || echo "")

              if [ -n "$APPSYNC_URL" ]; then
                echo "üåê Testing AppSync endpoint: $APPSYNC_URL"
                if curl -f -s --max-time 10 "$APPSYNC_URL" > /dev/null 2>&1; then
                  echo "‚úÖ AppSync endpoint is accessible"
                  API_AVAILABLE=true
                else
                  echo "‚ö†Ô∏è AppSync endpoint not accessible - backend tests will be skipped"
                  echo "üí° This is expected in CI when backend is not deployed to staging"
                fi
              fi
            fi

            echo "üß™ Running Playwright tests..."

            # Run different test suites based on API availability
            if [ "$API_AVAILABLE" = true ]; then
              echo "üîó Backend API available - running full test suite..."
              npx playwright test --grep-invert "Backend API Tests" --reporter=line || {
                echo "‚ùå Frontend tests failed"
                E2E_EXIT_CODE=1
              }
              # Run backend tests separately if API is available
              npx playwright test --grep "Backend API Tests" --reporter=line || {
                echo "‚ö†Ô∏è Backend API tests failed (but continuing)"
              }
              E2E_EXIT_CODE=$?
            else
              echo "üö´ Backend API not available - running frontend-only tests..."
              # Skip backend-dependent tests
              npx playwright test --grep-invert "Backend API Tests|backend-api" --reporter=line || {
                echo "‚ùå Frontend tests failed"
                E2E_EXIT_CODE=1
              }
              E2E_EXIT_CODE=$?
              echo "‚ÑπÔ∏è Backend API tests skipped (API not available in CI)"
            fi
          else
            echo "‚ÑπÔ∏è No Playwright config found, skipping E2E tests"
            E2E_EXIT_CODE=0
          fi

          # Calculate overall result
          if [ $TEST_EXIT_CODE -eq 0 ] && [ $E2E_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ All tests passed"
            echo "results=passed" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Tests failed"
            echo "results=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run linting and type checking
        run: |
          echo "üîç Running code quality checks..."
          pnpm lint
          npx tsc --noEmit

      - name: Security audit
        id: security
        run: |
          echo "üîí Running security audit..."
          pnpm audit --audit-level moderate
          if [ $? -eq 0 ]; then
            echo "‚úÖ Security audit passed"
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Security vulnerabilities found"
            echo "status=failed" >> $GITHUB_OUTPUT
            # Don't fail the job, just report
          fi

      - name: Code quality scan
        uses: github/super-linter/slim@v5
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Reduce linter noise - focus on critical issues
          FILTER_REGEX_EXCLUDE: .*\.(git|gitignore)$
          FILTER_REGEX_INCLUDE: .*\.(js|ts|tsx|jsx|json|md)$
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_JAVASCRIPT_ES: false
          VALIDATE_JAVASCRIPT_STANDARD: false
          VALIDATE_TYPESCRIPT_ES: false
          VALIDATE_TYPESCRIPT_STANDARD: false
          VALIDATE_JSON: true
          VALIDATE_MD: true
          ERROR_ON_MISSING_EXEC_BIT: false
          LOG_LEVEL: WARN

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_id }}
          path: |
            coverage/
            test-results/
            playwright-report/

  # Unified Production Deployment
  production-deployment:
    name: üöÄ Production Deployment
    needs: quality-assurance
    if: |
      (needs.quality-assurance.outputs.test-results == 'passed' &&
       needs.quality-assurance.outputs.security-scan != 'failed') ||
      (github.event.inputs.force_deploy == true)
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.rollback_version || github.sha }}
          fetch-depth: 0

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build for production
        run: pnpm run build
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          NEXT_PUBLIC_ENVIRONMENT: production
          NEXT_TELEMETRY_DISABLED: "1"

      - name: Performance baseline check
        run: |
          echo "üìä Running performance baseline check..."
          npx lighthouse https://baltzakisthemis.com \
            --output=json \
            --output-path=./baseline-results.json \
            --quiet || echo "Baseline check completed"

      - name: Deploy to AWS Amplify
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - name: Deploy Frontend to Production
        run: |
          echo "üöÄ Deploying frontend to Amplify production..."
          aws amplify start-deployment \
            --app-id ${{ env.PRODUCTION_APP_ID }} \
            --branch-name ${{ env.PRODUCTION_BRANCH }} \
            --source-dir .

      - name: Deploy Backend to Production
        run: |
          echo "üöÄ Deploying backend to production..."
          npx ampx pipeline-deploy \
            --outputs-format json \
            --outputs-out-dir ./production_outputs

      - name: Start Deployment Monitoring
        id: deployment-monitor
        run: |
          echo "üì° Starting deployment monitoring..."
          JOB_ID=$(aws amplify get-job --app-id ${{ env.PRODUCTION_APP_ID }} --branch-name ${{ env.PRODUCTION_BRANCH }} --job-id $(aws amplify list-jobs --app-id ${{ env.PRODUCTION_APP_ID }} --branch-name ${{ env.PRODUCTION_BRANCH }} --query 'jobSummaries[0].jobId' --output text) --query 'job.summary.status' --output text 2>/dev/null || echo "UNKNOWN")

          echo "job_status=$JOB_ID" >> $GITHUB_OUTPUT
          echo "deployment_job_id=$(aws amplify list-jobs --app-id ${{ env.PRODUCTION_APP_ID }} --branch-name ${{ env.PRODUCTION_BRANCH }} --query 'jobSummaries[0].jobId' --output text)" >> $GITHUB_OUTPUT

      - name: Monitor Deployment Progress
        run: |
          echo "üëÄ Monitoring deployment progress..."
          DEPLOYMENT_JOB_ID="${{ steps.deployment-monitor.outputs.deployment_job_id }}"

          for i in {1..40}; do  # Monitor for up to 20 minutes
            STATUS=$(aws amplify get-job --app-id ${{ env.PRODUCTION_APP_ID }} --branch-name ${{ env.PRODUCTION_BRANCH }} --job-id $DEPLOYMENT_JOB_ID --query 'job.summary.status' --output text 2>/dev/null || echo "UNKNOWN")

            echo "$(date '+%H:%M:%S') - Deployment Status: $STATUS"

            if [ "$STATUS" = "SUCCEED" ]; then
              echo "‚úÖ Deployment completed successfully!"
              break
            elif [ "$STATUS" = "FAILED" ]; then
              echo "‚ùå Deployment failed"
              exit 1
            elif [ "$STATUS" = "CANCELLED" ]; then
              echo "‚ö†Ô∏è Deployment cancelled"
              exit 1
            fi

            sleep 30
          done

          echo "‚è∞ Deployment monitoring completed"

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-deployment-${{ github.run_id }}
          path: |
            production_outputs/
            baseline-results.json

  # Post-Deployment Validation
  deployment-validation:
    name: ‚úÖ Deployment Validation
    needs: production-deployment
    runs-on: ubuntu-latest
    if: needs.production-deployment.result == 'success'

    steps:
      - name: Wait for deployment stabilization
        run: sleep 180

      - name: Production Health Validation
        run: |
          echo "üè• Running production health validation..."

          # Check site accessibility
          SITE_URL="https://baltzakisthemis.com"
          if curl -f -s --max-time 30 "$SITE_URL" > /dev/null; then
            echo "‚úÖ Production site is accessible: $SITE_URL"

            # Check for critical content
            if curl -s "$SITE_URL" | grep -q "Themistoklis"; then
              echo "‚úÖ Critical content loaded successfully"
            else
              echo "‚ö†Ô∏è Critical content not found (may be expected)"
            fi
          else
            echo "‚ùå Production site is not accessible"
            exit 1
          fi

          # Check API endpoints (if they exist)
          if curl -f -s --max-time 10 "$SITE_URL/api/health" > /dev/null 2>&1; then
            echo "‚úÖ API endpoints are responding"
          else
            echo "‚ÑπÔ∏è API endpoints not accessible (may not be implemented)"
          fi

      - name: Performance Validation
        run: |
          echo "‚ö° Running post-deployment performance validation..."
          npx lighthouse https://baltzakisthemis.com \
            --output=json \
            --output-path=./validation-results.json \
            --quiet || echo "Performance validation completed"

          # Check if load time is reasonable
          LOAD_TIME=$(jq -r '.audits["speed-index"].displayValue' validation-results.json 2>/dev/null | sed 's/s$//')
          if [ -n "$LOAD_TIME" ] && [ "${LOAD_TIME%.*}" -lt 5000 ]; then
            echo "‚úÖ Performance within acceptable limits (${LOAD_TIME}ms)"
          else
            echo "‚ö†Ô∏è Performance check inconclusive"
          fi

      - name: Deployment Success Notification
        run: |
          echo "üéâ Production deployment completed and validated successfully!"
          echo "üìä Deployment Summary:"
          echo "   - Environment: Production"
          echo "   - Branch: ${{ env.PRODUCTION_BRANCH }}"
          echo "   - Commit: ${{ github.sha }}"
          echo "   - Site URL: https://baltzakisthemis.com"
          echo "   - Deployed by: ${{ github.actor }}"
          echo "   - Timestamp: $(date -u)"

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        with:
          name: deployment-validation-${{ github.run_id }}
          path: ./validation-results.json

  # Rollback capability (manual trigger)
  rollback:
    name: üîÑ Emergency Rollback
    if: failure() && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Rollback Alert
        run: |
          echo "‚ö†Ô∏è Production deployment failed or health checks failed"
          echo "üîÑ Emergency rollback may be needed"
          echo "üìû Contact development team for rollback procedures"

      - name: AWS Credentials for Rollback
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - name: Prepare Rollback Information
        run: |
          echo "üìã Rollback Information:"
          echo "   - App ID: ${{ env.PRODUCTION_APP_ID }}"
          echo "   - Branch: ${{ env.PRODUCTION_BRANCH }}"
          echo "   - Previous deployment can be restored via Amplify console"
          echo "   - Contact: DevOps team for immediate rollback"
