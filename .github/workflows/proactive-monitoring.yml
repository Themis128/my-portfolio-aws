name: ğŸ” Proactive Application Monitoring

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Environment to monitor'
        required: false
        default: 'production'
        type: choice
        options:
        - production
        - staging
        - development

env:
  NODE_VERSION: '20'

jobs:
  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.14.4
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Determine target environment
        id: env-config
        run: |
          TARGET_ENV="${{ github.event.inputs.target_environment || 'production' }}"

          case $TARGET_ENV in
            "production")
              echo "url=https://baltzakisthemis.com" >> $GITHUB_OUTPUT
              echo "api_url=https://baltzakisthemis.com/api" >> $GITHUB_OUTPUT
              echo "environment=production" >> $GITHUB_OUTPUT
              ;;
            "staging")
              echo "url=https://staging.dcwmv1pw85f0j.amplifyapp.com" >> $GITHUB_OUTPUT
              echo "api_url=https://staging.dcwmv1pw85f0j.amplifyapp.com/api" >> $GITHUB_OUTPUT
              echo "environment=staging" >> $GITHUB_OUTPUT
              ;;
            "development")
              echo "url=https://develop.dcwmv1pw85f0j.amplifyapp.com" >> $GITHUB_OUTPUT
              echo "api_url=https://develop.dcwmv1pw85f0j.amplifyapp.com/api" >> $GITHUB_OUTPUT
              echo "environment=development" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Site Availability Check
        id: availability
        run: |
          TARGET_URL="${{ steps.env-config.outputs.url }}"
          ENVIRONMENT="${{ steps.env-config.outputs.environment }}"

          echo "ğŸ” Checking $ENVIRONMENT site availability: $TARGET_URL"

          # Check HTTP status
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET_URL")
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" "$TARGET_URL")

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… Site is UP (HTTP $HTTP_STATUS, ${RESPONSE_TIME}s)"
            echo "status=up" >> $GITHUB_OUTPUT
            echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
          else
            echo "âŒ Site is DOWN (HTTP $HTTP_STATUS)"
            echo "status=down" >> $GITHUB_OUTPUT
            echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
          fi

      - name: API Health Check
        id: api-health
        run: |
          API_URL="${{ steps.env-config.outputs.api_url }}"
          ENVIRONMENT="${{ steps.env-config.outputs.environment }}"

          echo "ğŸ” Checking $ENVIRONMENT API health: $API_URL/health"

          # Check API health endpoint
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/health" || echo "000")

          if [ "$API_STATUS" -eq 200 ]; then
            echo "âœ… API is HEALTHY (HTTP $API_STATUS)"
            echo "api_status=healthy" >> $GITHUB_OUTPUT
          elif [ "$API_STATUS" -eq 404 ]; then
            echo "âš ï¸ API health endpoint not found (may be expected)"
            echo "api_status=not_configured" >> $GITHUB_OUTPUT
          else
            echo "âŒ API is UNHEALTHY (HTTP $API_STATUS)"
            echo "api_status=unhealthy" >> $GITHUB_OUTPUT
          fi

      - name: Performance Monitoring
        id: performance
        run: |
          TARGET_URL="${{ steps.env-config.outputs.url }}"
          ENVIRONMENT="${{ steps.env-config.outputs.environment }}"

          echo "âš¡ Running performance check for $ENVIRONMENT..."

          # Basic performance metrics
          LOAD_TIME=$(curl -s -o /dev/null -w "%{time_total}" "$TARGET_URL")
          DNS_TIME=$(curl -s -o /dev/null -w "%{time_namelookup}" "$TARGET_URL")
          CONNECT_TIME=$(curl -s -o /dev/null -w "%{time_connect}" "$TARGET_URL")

          echo "ğŸ“Š Performance Metrics:"
          echo "   - Total Load Time: ${LOAD_TIME}s"
          echo "   - DNS Resolution: ${DNS_TIME}s"
          echo "   - Connection Time: ${CONNECT_TIME}s"

          # Alert if load time is too slow (> 5 seconds)
          if (( $(echo "$LOAD_TIME > 5.0" | bc -l) )); then
            echo "âš ï¸ Slow load time detected: ${LOAD_TIME}s"
            echo "performance_alert=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Load time is acceptable"
            echo "performance_alert=false" >> $GITHUB_OUTPUT
          fi

          echo "load_time=$LOAD_TIME" >> $GITHUB_OUTPUT
          echo "dns_time=$DNS_TIME" >> $GITHUB_OUTPUT
          echo "connect_time=$CONNECT_TIME" >> $GITHUB_OUTPUT

      - name: Content Validation
        id: content-check
        run: |
          TARGET_URL="${{ steps.env-config.outputs.url }}"
          ENVIRONMENT="${{ steps.env-config.outputs.environment }}"

          echo "ğŸ“„ Checking content integrity for $ENVIRONMENT..."

          # Check for critical content
          CONTENT=$(curl -s "$TARGET_URL")

          if echo "$CONTENT" | grep -q "Themistoklis"; then
            echo "âœ… Critical content found"
            echo "content_valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Critical content missing"
            echo "content_valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Error Detection
        id: error-check
        run: |
          TARGET_URL="${{ steps.env-config.outputs.url }}"
          ENVIRONMENT="${{ steps.env-config.outputs.environment }}"

          echo "ğŸ” Scanning for errors in $ENVIRONMENT..."

          # Check for common error patterns
          CONTENT=$(curl -s "$TARGET_URL")

          ERROR_FOUND=false

          if echo "$CONTENT" | grep -i -q "error\|exception\|500\|404"; then
            echo "âš ï¸ Error patterns detected in page content"
            ERROR_FOUND=true
          fi

          # Check response headers for error status
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET_URL")
          if [ "$STATUS" -ge 400 ]; then
            echo "âš ï¸ HTTP error status: $STATUS"
            ERROR_FOUND=true
          fi

          if [ "$ERROR_FOUND" = true ]; then
            echo "errors_detected=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No errors detected"
            echo "errors_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Health Report
        run: |
          ENVIRONMENT="${{ steps.env-config.outputs.environment }}"
          SITE_STATUS="${{ steps.availability.outputs.status }}"
          API_STATUS="${{ steps.api-health.outputs.api_status }}"
          LOAD_TIME="${{ steps.performance.outputs.load_time }}"
          PERFORMANCE_ALERT="${{ steps.performance.outputs.performance_alert }}"
          CONTENT_VALID="${{ steps.content-check.outputs.content_valid }}"
          ERRORS_DETECTED="${{ steps.error-check.outputs.errors_detected }}"

          echo "ğŸ“Š Health Report for $ENVIRONMENT Environment" >> health-report.md
          echo "==========================================" >> health-report.md
          echo "" >> health-report.md
          echo "â° Timestamp: $(date)" >> health-report.md
          echo "ğŸŒ Environment: $ENVIRONMENT" >> health-report.md
          echo "" >> health-report.md
          echo "## Status Summary" >> health-report.md
          echo "- Site Availability: $([ "$SITE_STATUS" = "up" ] && echo "âœ… UP" || echo "âŒ DOWN")" >> health-report.md
          echo "- API Health: $([ "$API_STATUS" = "healthy" ] && echo "âœ… HEALTHY" || echo "âš ï¸ $API_STATUS")" >> health-report.md
          echo "- Load Time: ${LOAD_TIME}s $([ "$PERFORMANCE_ALERT" = "true" ] && echo "âš ï¸ SLOW" || echo "âœ… OK")" >> health-report.md
          echo "- Content Integrity: $([ "$CONTENT_VALID" = "true" ] && echo "âœ… VALID" || echo "âŒ INVALID")" >> health-report.md
          echo "- Error Detection: $([ "$ERRORS_DETECTED" = "true" ] && echo "âš ï¸ ERRORS FOUND" || echo "âœ… CLEAN")" >> health-report.md
          echo "" >> health-report.md
          echo "## Actions Required" >> health-report.md

          ACTIONS_NEEDED=false

          if [ "$SITE_STATUS" != "up" ]; then
            echo "- ğŸš¨ **CRITICAL**: Site is down - immediate investigation required" >> health-report.md
            ACTIONS_NEEDED=true
          fi

          if [ "$API_STATUS" = "unhealthy" ]; then
            echo "- âš ï¸ **WARNING**: API health check failed" >> health-report.md
            ACTIONS_NEEDED=true
          fi

          if [ "$PERFORMANCE_ALERT" = "true" ]; then
            echo "- âš ï¸ **WARNING**: Slow load time detected (${LOAD_TIME}s)" >> health-report.md
            ACTIONS_NEEDED=true
          fi

          if [ "$CONTENT_VALID" = "false" ]; then
            echo "- âš ï¸ **WARNING**: Content integrity issues detected" >> health-report.md
            ACTIONS_NEEDED=true
          fi

          if [ "$ERRORS_DETECTED" = "true" ]; then
            echo "- âš ï¸ **WARNING**: Error patterns detected" >> health-report.md
            ACTIONS_NEEDED=true
          fi

          if [ "$ACTIONS_NEEDED" = false ]; then
            echo "- âœ… No actions required - all systems healthy" >> health-report.md
          fi

      - name: Upload Health Report
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ steps.env-config.outputs.environment }}-$(date +%Y%m%d-%H%M%S)
          path: health-report.md

      - name: Send Alert on Critical Issues
        if: |
          steps.availability.outputs.status != 'up' ||
          steps.api-health.outputs.api_status == 'unhealthy' ||
          steps.content-check.outputs.content_valid == 'false'
        run: |
          ENVIRONMENT="${{ steps.env-config.outputs.environment }}"

          echo "ğŸš¨ CRITICAL ALERT: Issues detected in $ENVIRONMENT environment"
          echo "ğŸ“§ Consider sending notifications to development team"
          echo "ğŸ”— Check the health report artifact for detailed information"

          # Here you could add Slack, Discord, or email notifications
          # Example: curl -X POST -H 'Content-type: application/json' --data '{"text":"ğŸš¨ Critical issues in production!"}' $SLACK_WEBHOOK_URL

  # Database/Backend Health Check (if applicable)
  backend-health:
    name: ğŸ”§ Backend Health Check
    runs-on: ubuntu-latest
    if: github.event.inputs.target_environment != 'development' || github.event.inputs.target_environment == ''

    steps:
      - name: Backend Services Check
        run: |
          echo "ğŸ”§ Checking backend services health..."

          # This could be expanded to check:
          # - Database connectivity
          # - Lambda function health
          # - AppSync API status
          # - S3 bucket accessibility
          # - etc.

          echo "âœ… Backend health check completed"
          echo "ğŸ“ Add specific backend service checks as needed"

  # Cleanup old artifacts (run weekly)
  cleanup:
    name: ğŸ§¹ Cleanup Old Artifacts
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * 0'  # Run weekly on Sundays

    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            const oldArtifacts = artifacts.data.artifacts.filter(artifact => {
              const createdAt = new Date(artifact.created_at);
              return createdAt < oneWeekAgo && artifact.name.includes('health-report');
            });

            for (const artifact of oldArtifacts) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
              });
              console.log(`Deleted old artifact: ${artifact.name}`);
            }

            console.log(`Cleaned up ${oldArtifacts.length} old health report artifacts`);
